# コード品質向上・テスト基盤構築

## ✅ 完了情報
- **完了日時**: 2025-09-03
- **担当者**: Claude Code Assistant
- **実装状況**: フロントエンドテスト基盤完了
- **成果物**: 
  - Chart.js/D3.js モック修正
  - Canvas API モック実装
  - ResizeObserver モック実装
  - テストアサーション修正（Dashboard）
  - E2E/Playwright設定問題解決
  - テストカバレッジ基盤整備
- **テストツール**: Vitest, @vue/test-utils, Playwright, ESLint, Prettier

## 概要
フロントエンド（Vue.js）とバックエンド（Python）の両方について、テストフレームワーク導入、リンター・フォーマッター設定、CI/CDパイプライン構築により、持続可能な高品質開発環境を整備する。

## 目的
- バグの早期発見・修正によるシステム安定性向上
- コードの可読性・保守性向上
- 新機能追加時のリグレッション防止
- チーム開発での一貫したコード品質確保
- デプロイ・リリースプロセスの自動化

## 主要機能

### 1. フロントエンドテスト基盤
- **ユニットテスト**: Vue コンポーネント・関数のテスト
- **統合テスト**: コンポーネント間連携のテスト
- **E2Eテスト**: ユーザーシナリオの自動テスト
- **スナップショットテスト**: UI変更の検出

### 2. バックエンドテスト基盤
- **ユニットテスト**: 関数・メソッドの単体テスト
- **統合テスト**: API・データベース連携テスト
- **パフォーマンステスト**: レスポンス時間・負荷テスト
- **セキュリティテスト**: 認証・認可・脆弱性テスト

### 3. コード品質管理
- **静的解析**: ESLint（JS）・Pylint（Python）
- **フォーマッター**: Prettier（JS）・Black（Python）
- **型チェック**: TypeScript・mypy（Python）
- **カバレッジ測定**: テストカバレッジレポート

### 4. CI/CD パイプライン
- **継続的統合**: プルリクエスト時の自動テスト実行
- **継続的デプロイ**: 本番環境への自動デプロイ
- **品質ゲート**: テスト・品質チェック通過条件
- **通知・レポート**: 結果の自動通知・レポート生成

## 技術要件

### フロントエンドテスト技術
- **Vitest**: Vue.jsに最適化されたテストフレームワーク
- **@vue/test-utils**: Vue コンポーネントテストユーティリティ
- **Playwright**: 高速・信頼性の高いE2Eテスト
- **MSW**: APIモック・統合テスト支援

### バックエンドテスト技術
- **pytest**: Pythonテストフレームワーク
- **pytest-asyncio**: 非同期テスト対応
- **httpx**: FastAPI テストクライアント
- **factory-boy**: テストデータ生成
- **pytest-cov**: カバレッジ測定

### CI/CD基盤
- **GitHub Actions**: CI/CDパイプライン
- **Docker**: 一貫した実行環境
- **SonarCloud**: コード品質分析（オプション）

## 実装内容

### Phase 1: フロントエンドテスト基盤（4週間）

1. **テスト環境構築**
   - Vitest設定・統合
   - @vue/test-utils導入
   - テスト用ユーティリティ作成
   
   ```javascript
   // vitest.config.js
   import { defineConfig } from 'vitest/config'
   import vue from '@vitejs/plugin-vue'

   export default defineConfig({
     plugins: [vue()],
     test: {
       environment: 'happy-dom',
       coverage: {
         provider: 'v8',
         reporter: ['text', 'html', 'lcov']
       }
     }
   })
   ```

2. **コンポーネントテスト実装**
   - KPIDashboard.vue のテスト
   - PopulationChart.vue のテスト
   - LivabilityScoreConfiguration.vue のテスト
   - Navigation.vue のテスト
   
   ```javascript
   // tests/components/KPIDashboard.spec.js
   import { mount } from '@vue/test-utils'
   import KPIDashboard from '@/components/KPIDashboard.vue'

   describe('KPIDashboard', () => {
     it('renders policy data correctly', () => {
       const policies = [/* test data */]
       const wrapper = mount(KPIDashboard, {
         props: { policies }
       })
       expect(wrapper.find('.text-2xl').text()).toContain('5件')
     })
   })
   ```

3. **E2Eテスト実装**
   - ユーザーフロー（住みやすさ評価→比較→地図表示）
   - 政策追跡フロー
   - データ可視化操作テスト

4. **API モックテスト**
   - MSW設定・モック定義
   - データフェッチングテスト
   - エラーハンドリングテスト

### Phase 2: バックエンドテスト基盤（3週間）

1. **テスト環境構築**
   - pytest設定・プラグイン導入
   - テスト用データベース設定
   - ファクトリー・フィクスチャ定義
   
   ```python
   # pytest.ini
   [tool:pytest]
   addopts = --cov=app --cov-report=term-missing --cov-report=html
   testpaths = tests
   python_files = test_*.py *_test.py
   python_classes = Test*
   python_functions = test_*
   ```

2. **APIテスト実装**
   - 統計データAPI テスト
   - 認証・認可テスト
   - バリデーション・エラーハンドリングテスト
   
   ```python
   # tests/api/test_population.py
   import pytest
   from httpx import AsyncClient
   from app.main import app

   @pytest.mark.asyncio
   async def test_get_population_data():
       async with AsyncClient(app=app, base_url="http://test") as client:
           response = await client.get("/api/population/tottori")
           assert response.status_code == 200
           assert "population" in response.json()
   ```

3. **データ処理テスト**
   - pandas データ変換テスト
   - 統計計算テスト
   - 外部API統合テスト

4. **パフォーマンス・セキュリティテスト**
   - 負荷テスト（locust等）
   - セキュリティ検査（bandit）
   - SQLインジェクション検査

### Phase 3: コード品質管理（2週間）

1. **フロントエンドコード品質**
   - ESLint設定・ルール定義
   - Prettier設定・統合
   - TypeScript移行（段階的）
   
   ```json
   // .eslintrc.js
   module.exports = {
     extends: [
       'eslint:recommended',
       '@vue/eslint-config-prettier',
       'plugin:vue/vue3-recommended'
     ],
     rules: {
       'vue/multi-word-component-names': 'off',
       'vue/require-default-prop': 'error'
     }
   }
   ```

2. **バックエンドコード品質**
   - Pylint・flake8設定
   - Black フォーマッター統合
   - mypy 型チェック導入
   
   ```toml
   # pyproject.toml
   [tool.black]
   line-length = 100
   target-version = ['py311']

   [tool.pylint]
   max-line-length = 100
   disable = ["C0114", "C0115", "C0116"]
   ```

3. **Pre-commit フック**
   - コミット前自動検査
   - フォーマット・リンター実行
   - テスト実行

### Phase 4: CI/CD パイプライン（3週間）

1. **GitHub Actions設定**
   - フロントエンド・バックエンド並列実行
   - テスト・品質検査の自動実行
   - カバレッジレポート生成
   
   ```yaml
   # .github/workflows/ci.yml
   name: CI/CD Pipeline
   on: [push, pull_request]

   jobs:
     frontend:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-node@v4
           with:
             node-version: '20'
         - run: npm ci
         - run: npm run lint
         - run: npm run test:coverage
         - run: npm run build

     backend:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-python@v4
           with:
             python-version: '3.11'
         - run: pip install -r requirements-dev.txt
         - run: pytest --cov=app
         - run: black --check app/
         - run: pylint app/
   ```

2. **品質ゲート設定**
   - テストカバレッジ閾値（80%以上）
   - リンター・フォーマッターエラー0件
   - セキュリティ脆弱性チェック通過

3. **デプロイメント自動化**
   - ステージング環境自動デプロイ
   - 本番環境承認フロー
   - ロールバック機能

## ファイル構造

### フロントエンド
```
frontend/
├── tests/
│   ├── components/           # コンポーネントテスト
│   ├── views/               # ページテスト
│   ├── utils/               # ユーティリティテスト
│   ├── e2e/                 # E2Eテスト
│   └── setup.js             # テストセットアップ
├── vitest.config.js         # Vitest設定
├── playwright.config.js     # Playwright設定
├── .eslintrc.js            # ESLint設定
└── .prettierrc             # Prettier設定
```

### バックエンド
```
backend/
├── tests/
│   ├── api/                 # APIテスト
│   ├── core/                # ビジネスロジックテスト
│   ├── models/              # モデルテスト
│   ├── utils/               # ユーティリティテスト
│   ├── conftest.py          # pytest設定
│   └── factories.py         # テストデータファクトリー
├── pytest.ini              # pytest設定
├── pyproject.toml          # Python設定
└── .pre-commit-config.yaml # pre-commit設定
```

## テストカバレッジ目標
- **フロントエンド**: 80%以上（コンポーネント・ユーティリティ）
- **バックエンド**: 85%以上（API・ビジネスロジック）
- **E2E**: 主要ユーザーフロー100%カバー
- **API**: 全エンドポイント100%カバー

## 成功指標
- **テストカバレッジ**: フロントエンド80%、バックエンド85%以上
- **CI/CDパイプライン**: 実行時間10分以内、成功率95%以上
- **コード品質**: SonarCloud品質評価A評価以上
- **デプロイ頻度**: 週1回以上の安定デプロイ
- **バグ検出**: 本番環境バグ80%削減（テスト段階での検出）

## リスク・対策
- **テスト実行時間**: 大量テストによる遅延 → 並列実行・キャッシュ活用
- **テストメンテナンス**: テストコード保守負荷 → シンプルで可読性の高いテスト設計
- **学習コスト**: 新ツール導入による学習時間 → 段階的導入・ドキュメント整備

## 完了条件
- [ ] Vitest・@vue/test-utils 導入・設定完了
- [ ] 主要コンポーネントテスト実装（15コンポーネント以上）
- [ ] Playwright E2Eテスト実装（5シナリオ以上）
- [ ] pytest・FastAPIテスト実装
- [ ] APIテスト全エンドポイントカバー
- [ ] ESLint・Prettier・Black・Pylint設定完了
- [ ] GitHub Actions CI/CDパイプライン構築
- [ ] カバレッジ目標達成（フロントエンド80%、バックエンド85%）
- [ ] Pre-commit フック設定
- [ ] テストドキュメント・ガイド作成

## 工数見積もり
**合計: 12週間**
- Phase 1 (フロントエンドテスト): 4週間
- Phase 2 (バックエンドテスト): 3週間
- Phase 3 (コード品質): 2週間
- Phase 4 (CI/CD): 3週間

## 次のステップ
1. Vitest・@vue/test-utils導入
2. 基本的なコンポーネントテスト作成
3. ESLint・Prettier設定
4. GitHub Actions基本パイプライン構築
5. pytest環境構築・APIテスト実装